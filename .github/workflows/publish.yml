name: Publish to PyPI

on:
  release:
    types: [published]
  pull_request:
    paths:
      - 'pyproject.toml'
      - 'web_hacker/**'
      - '.github/workflows/publish.yml'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build only, no publish)'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build distribution
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling

      - name: Build package
        run: python -m build

      - name: Get version from built package
        id: get-version
        run: |
          VERSION=$(ls dist/*.whl | sed 's/.*web_hacker-\(.*\)-py3.*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Test local wheel
        run: |
          pip install dist/*.whl
          python -c "import web_hacker"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pypi-dist
          path: dist/

  build-testpypi:
    name: Build TestPyPI distribution
    if: >
      github.event_name == 'release' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling

      - name: Add dev suffix
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
          NEW_VERSION="${VERSION}.dev${TIMESTAMP}"
          sed -i "s/version = \"$VERSION\"/version = \"$NEW_VERSION\"/" pyproject.toml
          echo "TESTPYPI_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Build
        run: python -m build

      - uses: actions/upload-artifact@v4
        with:
          name: testpypi-dist
          path: dist/

  publish-testpypi:
    name: Publish to TestPyPI
    needs: build-testpypi
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: testpypi-dist
          path: dist/

      - id: get-version
        run: |
          VERSION=$(ls dist/*.whl | sed 's/.*web_hacker-\(.*\)-py3.*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  test-install-testpypi:
    name: Verify TestPyPI install
    needs: publish-testpypi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install from TestPyPI ONLY
        run: |
          VERSION="${{ needs.publish-testpypi.outputs.version }}"
          echo "Installing web-hacker==$VERSION"

          for i in {1..10}; do
            if uv pip install --system --pre \
              --index-url https://test.pypi.org/simple/ \
              --no-extra-index \
              "web-hacker==$VERSION"; then
              python -c "import web_hacker"
              exit 0
            fi
            sleep 30
          done

          echo "TestPyPI install failed"
          exit 1

  publish-pypi:
    name: Publish to PyPI
    if: github.event_name == 'release'
    needs: [build, test-install-testpypi]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: pypi-dist
          path: dist/

      - uses: pypa/gh-action-pypi-publish@release/v1

  test-install-pypi:
    name: Verify PyPI install
    if: github.event_name == 'release'
    needs: publish-pypi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install from PyPI
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          for i in {1..10}; do
            if uv pip install --system "web-hacker==$VERSION"; then
              python -c "import web_hacker"
              exit 0
            fi
            sleep 30
          done
          exit 1
